{% extends "layout.html" %}
{% block title %}
    Admin Dashboard
{% endblock %}

{% block main %}
<div class="container mt-4">
    <h1 class="text-light">Item Record</h1>
    <div class="search-bar-wrapper d-flex">
        <input id="search-input" type="text" placeholder="Search..." class="form-control search-bar mb-3">
        <!-- Reset Button -->
        <button id="reset-btn" class="btn custom-green-btn mb-3 ml-10">Reset</button>
    </div>
    <div id="table-container" class="table-responsive" style="width: 90vw; overflow-y: auto; margin-left: -10em;"></div> <!-- Div for Tabulator -->
</div>

<!-- Include Tabulator CDN -->
<link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css">
<script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    let tableData;
    try {
        tableData = JSON.parse(`{{ items | tojson | safe }}`);
    } catch (e) {
        console.error("Error parsing JSON:", e);
        tableData = [];
    }

    const table = new Tabulator("#table-container", {
        data: tableData,
        layout: "fitColumns",
        height: "65vh",
        columns: [
            { title: "ID", field: "id", width: 50, editor: false },
            { 
                title: "Status", 
                field: "item_status", 
                width: 100, 
                editor: "select", 
                editorParams: {
                    values: ["Lost", "Found", "Confirmed"]
                },
                cellEdited: function(cell) {
                    // When the cell is edited, update the database
                    const rowData = cell.getRow().getData();
                    fetch('/update-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: rowData.id,
                            item_status: cell.getValue()
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            alert("Error updating status: " + data.error);
                            cell.restoreOldValue(); // Revert to old value if update fails
                        }
                    })
                    .catch(err => {
                        alert("An error occurred: " + err);
                        cell.restoreOldValue();
                    });
                }
            },
            { title: "Lost Date", field: "lost_date", width: 90 },
            { title: "Found Date", field: "found_date", width: 90 },
            { title: "Lost Location", field: "location", width: 200 },
            { title: "Found Location", field: "found_location", width: 150 },
            { title: "Description", field: "item_description" },
            {
                title: "Image",
                field: "image_url",
                formatter: function(cell) {
                    const value = cell.getValue();
                    return `<div style="text-align: center;">
                                <a href="${value}" target="_blank">
                                    <img src="${value}" style="height: 50px; width: auto;" />
                                </a>
                            </div>`;
                },
                width: 100
            },
            {
                title: "Email",
                field: "email",
                width: 200,
                formatter: function(cell, formatterParams, onRendered) {
                    const email = cell.getValue();
                    const rowData = cell.getRow().getData();
                    const itemStatus = rowData.item_status;
                    const itemDescription = rowData.item_description;

                    const subject = `Re: Lost Item Report - ${itemDescription}`;
                    let body = `Hello,\n\nThis is a response regarding your lost item report. Details:\n\nItem Status: ${itemStatus}\nItem Description: ${itemDescription}\n\nBest regards,\n[Name]`;

                    const gmailComposeUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

                    return `<a href="${gmailComposeUrl}" style="color: white; text-decoration: underline;" target="_blank">${email}</a>`;
                }
            },
            { title: "Group", field: "grade_and_section", width: 80 },
            { title: "Phone Number", field: "phone_number", width: 100 },
        ],

        // Enable the cell click event
        cellClick: function(e, cell) {
            // Get the value of the clicked cell
            const clickedValue = cell.getValue();
            
            // Apply a filter based on the clicked cell value (for example, filter by status)
            if (clickedValue) {
                table.setFilter(cell.getColumn().getField(), "=", clickedValue);
            }
        }
    });

    // Search input event
    document.getElementById('search-input').addEventListener('input', function (e) {
        const value = e.target.value.toLowerCase();
        table.clearFilter();
        table.setFilter(function (data) {
            return Object.values(data).some(val =>
                String(val).toLowerCase().includes(value)
            );
        });
    });

    // Reset Button Event
    document.getElementById('reset-btn').addEventListener('click', function () {
        table.clearFilter();
    });
});


</script>
{% endblock %}
