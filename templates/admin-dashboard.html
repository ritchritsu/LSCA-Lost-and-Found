{% extends "layout.html" %}
{% block title %}
    Admin Dashboard
{% endblock %}

{% block main %}
<div class="container mt-4">
    <h1 class="text-light">SHS Item Record</h1>
    <div class="search-bar-wrapper">
        <input id="search-input" type="text" placeholder="Search..." class="form-control search-bar mb-3">
        <!-- Reset Button -->
        <button id="reset-btn" class="btn custom-green-btn mb-3 ml-2">Reset</button>
    </div>
    <div id="table-container" class="table-responsive" style="width: 80vw; overflow-y: auto; margin-left: -5em;"></div> <!-- Div for Tabulator -->
</div>

<!-- Include Tabulator CDN -->
<link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css">
<script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tableData = JSON.parse(`{{ items | tojson | safe }}`); // Flask data
    
        const table = new Tabulator("#table-container", {
            data: tableData,
            layout: "fitColumns",
            height: "500px",  // Set a fixed height for the table container
            columns: [
                { title: "ID", field: "id", width: 50 },
                { title: "Status", field: "item_status" },
                { title: "Lost Date", field: "lost_date" },
                { title: "Found Date", field: "found_date" },
                { title: "Lost Location", field: "location" },
                { title: "Found Location", field: "found_location" },
                { title: "Description", field: "item_description" },
                {
                    title: "Image",
                    field: "image_url",
                    formatter: function(cell) {
                        const value = cell.getValue();
                        return `<a href="${value}" target="_blank"><img src="${value}" style="height: 50px; width: auto;" /></a>`;
                    }
                },
                { title: "Email", field: "email" },
                { title: "Grade and Section", field: "grade_and_section" },
                { title: "Phone Number", field: "phone_number" },
            ],
    
            rowClick: function (e, row) {
                const rowData = row.getData(); // Get the row data
                console.log("Row clicked, data:", rowData); // Log clicked row data
            },
        });
    
        // Cell Click Event for Filtering
        document.getElementById('table-container').addEventListener('click', function(e) {
            const cell = e.target.closest('.tabulator-cell'); // Find the closest tabulator cell
            if (cell) {
                const value = cell.textContent.trim().toLowerCase(); // Get the cell value
                console.log("Cell clicked, value:", value); // Log the clicked value
    
                // Filter the table based on the clicked cell's value
                table.clearFilter(); // Clear previous filters
                table.setFilter(function(data) {
                    // Check if any field contains the clicked value (partial match)
                    return Object.values(data).some(val =>
                        String(val).toLowerCase().includes(value)
                    );
                });
            }
        });
    
        // Search input event
        document.getElementById('search-input').addEventListener('input', function (e) {
            const value = e.target.value.toLowerCase();
            table.clearFilter(); // Clear previous filters
            table.setFilter(function (data) {
                return Object.values(data).some(val =>
                    String(val).toLowerCase().includes(value)
                );
            });
        });
    
        // Reset Button Event
        document.getElementById('reset-btn').addEventListener('click', function () {
            table.clearFilter(); // Clear all filters and show all rows
        });
    
        // Reset on Click Outside Table
        document.addEventListener('click', function(e) {
            if (!document.getElementById('table-container').contains(e.target) &&
                !document.getElementById('search-input').contains(e.target)) {
                table.clearFilter(); // Reset table if clicked outside the table or search input
            }
        });
    });
</script>

{% endblock %}
