{% extends "layout.html" %} {% block title %}Audit Log{% endblock %} {% block
main %}
<div class="container mt-4">
  <h1 class="text-light mb-4">Audit Log</h1>

  <!-- Search Bar -->
  <div class="mb-4">
    <input
      type="text"
      id="searchInput"
      class="form-control custom-input"
      placeholder="Search in logs..."
      style="max-width: 600px; margin: 0 auto"
    />
  </div>

  <div class="table-responsive" style="height: 65vh; overflow-y: auto">
    <table class="table table-dark" id="auditTable">
      <thead style="position: sticky; top: 0; z-index: 1">
        <tr>
          <th
            class="sortable"
            data-sort="timestamp"
            style="background-color: #065a2b; cursor: pointer"
          >
            Timestamp <span class="sort-icon">↕</span>
          </th>
          <th
            class="sortable"
            data-sort="user"
            style="background-color: #065a2b; cursor: pointer"
          >
            User <span class="sort-icon">↕</span>
          </th>
          <th
            class="sortable"
            data-sort="action"
            style="background-color: #065a2b; cursor: pointer"
          >
            Action <span class="sort-icon">↕</span>
          </th>
          <th
            class="sortable"
            data-sort="itemid"
            style="background-color: #065a2b; cursor: pointer"
          >
            Item ID <span class="sort-icon">↕</span>
          </th>
          <th
            class="sortable"
            data-sort="details"
            style="background-color: #065a2b; cursor: pointer"
          >
            Details <span class="sort-icon">↕</span>
          </th>
        </tr>
      </thead>
      <tbody id="logTableBody">
        {% for log in logs %}
        <tr class="log-row" style="background-color: #065a2b">
          <td data-value="{{ log.local_time }}">{{ log.local_time }}</td>
          <td data-value="{{ log.user_email }}">{{ log.user_email }}</td>
          <td data-value="{{ log.action_type }}">{{ log.action_type }}</td>
          <td data-value="{{ log.item_id }}">{{ log.item_id or 'N/A' }}</td>
          <td data-value="{{ log.details }}">{{ log.details }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // Existing search functionality
  document
    .getElementById("searchInput")
    .addEventListener("input", function (e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.getElementsByClassName("log-row");

      Array.from(rows).forEach((row) => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? "" : "none";
      });
    });

  // Sorting functionality
  document.querySelectorAll(".sortable").forEach((header) => {
    header.addEventListener("click", function () {
      const table = document.getElementById("auditTable");
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const index = this.cellIndex;
      const isAsc = !this.classList.contains("asc");

      // Reset all headers
      document.querySelectorAll(".sortable").forEach((h) => {
        h.classList.remove("asc", "desc");
        h.querySelector(".sort-icon").textContent = "↕";
      });

      // Set current header
      this.classList.add(isAsc ? "asc" : "desc");
      this.querySelector(".sort-icon").textContent = isAsc ? "↑" : "↓";

      // Sort rows
      rows.sort((a, b) => {
        let aVal =
          a.cells[index].getAttribute("data-value") ||
          a.cells[index].textContent;
        let bVal =
          b.cells[index].getAttribute("data-value") ||
          b.cells[index].textContent;

        // Handle 'N/A' values
        if (aVal === "N/A") return isAsc ? 1 : -1;
        if (bVal === "N/A") return isAsc ? -1 : 1;

        // Handle dates
        if (this.dataset.sort === "timestamp") {
          return isAsc
            ? new Date(aVal) - new Date(bVal)
            : new Date(bVal) - new Date(aVal);
        }

        // Handle numbers
        if (this.dataset.sort === "itemid") {
          return isAsc
            ? Number(aVal) - Number(bVal)
            : Number(bVal) - Number(aVal);
        }

        // Handle strings
        return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
      });

      // Reorder table
      rows.forEach((row) => tbody.appendChild(row));
    });
  });
</script>

<style>
  .table-responsive::-webkit-scrollbar {
    width: 12px;
  }

  .table-responsive::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
  }

  .table-responsive::-webkit-scrollbar-thumb {
    background-color: #065a2b;
    border-radius: 6px;
    border: 2px solid rgba(255, 255, 255, 0.1);
  }

  .table-responsive::-webkit-scrollbar-thumb:hover {
    background-color: #065a2b;
  }

  .custom-input {
    background-color: transparent;
    border: none;
    border-bottom: 2px solid #86c232;
    color: #ffffff;
  }

  .table-striped > tbody > tr:nth-of-type(2n + 1) > * {
    --bs-table-color-type: var(--bs-table-striped-color);
    --bs-table-bg-type: ##065a2b;
  }

  .sortable:hover {
    background-color: #087830 !important;
  }

  .sort-icon {
    display: inline-block;
    margin-left: 5px;
  }

  .asc .sort-icon::after {
    content: "↑";
  }

  .desc .sort-icon::after {
    content: "↓";
  }
</style>
{% endblock %}
