{% extends "layout.html" %}
{% block title %}
    Admin Dashboard
{% endblock %}

{% block main %}
<div class="container mt-4">
    <h1 class="text-light">SHS Item Record</h1>
    <div class="search-bar-wrapper d-flex">
        <input id="search-input" type="text" placeholder="Search..." class="form-control search-bar mb-3">
        <!-- Reset Button -->
        <button id="reset-btn" class="btn custom-green-btn mb-3 ml-10">Reset</button>
    </div>
    <div id="table-container" class="table-responsive" style="width: 90vw; overflow-y: auto; margin-left: -10em;"></div> <!-- Div for Tabulator -->
</div>

<!-- Include Tabulator CDN -->
<link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css">
<script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const tableData = JSON.parse(`{{ items | tojson | safe }}`); // Flask data

    const table = new Tabulator("#table-container", {
        data: tableData,
        layout: "fitColumns",
        height: "65vh",  // Set a fixed height for the table container
        columns: [
            { title: "ID", field: "id", width: 50 },
            { title: "Status", field: "item_status", width: 60 },
            { title: "Lost Date", field: "lost_date", width: 90 },
            { title: "Found Date", field: "found_date", width: 90 },
            { title: "Lost Location", field: "location", width: 160 },
            { title: "Found Location", field: "found_location", width: 150 },
            { title: "Description", field: "item_description" },
            {
                title: "Image",
                field: "image_url",
                formatter: function(cell) {
                    const value = cell.getValue();
                    return `<div style="text-align: center;">
                                <a href="${value}" target="_blank">
                                    <img src="${value}" style="height: 50px; width: auto;" />
                                </a>
                            </div>`;
                },
                width: 100
            },
            {
    title: "Email",
    field: "email",
    width: 200,
    formatter: function(cell, formatterParams, onRendered) {
        const email = cell.getValue();
        const rowData = cell.getRow().getData(); // Get row data
        const itemStatus = rowData.item_status;
        const itemDescription = rowData.item_description;
        const location = rowData.location;
        const foundLocation = rowData.found_location;
        const lostDate = rowData.lost_date;
        const foundDate = rowData.found_date;

        // Customize the subject and body based on the item status or additional instructions
        const subject = `Re: Lost Item Report - ${itemDescription}`;

        // Dynamic body based on item status and admin input
        let body = `
            Hello,

            This is a response regarding your lost item report. Here are the details of the item:

            - Item Status: ${itemStatus}
            - Item Description: ${itemDescription}
            - Lost Location: ${location}
            - Found Location: ${foundLocation || 'N/A'}
            - Lost Date: ${lostDate || 'N/A'}
            - Found Date: ${foundDate || 'N/A'}

            `;
        
        // Add condition based on item status to customize the message
        if (itemStatus.toLowerCase() === 'lost') {
            body += `
                Unfortunately, the item is still listed as lost. Please feel free to provide any additional details, and we'll continue our search.
            `;
        } else if (itemStatus.toLowerCase() === 'found') {
            body += `
                Great news! The item has been found. Please confirm if you'd like to pick it up or need further assistance.
            `;
        }

        // Additional message section if the admin needs to ask for more details
        body += `
            If you have any additional questions or information, feel free to reach out.

            Best regards,
            [Name]
        `;

        // Encode the subject and body to ensure they are URL-safe
        const encodedSubject = encodeURIComponent(subject);
        const encodedBody = encodeURIComponent(body);

        // Construct the Gmail compose URL with the encoded subject and body
        const gmailComposeUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}&su=${encodedSubject}&body=${encodedBody}`;

        // Return the hyperlink with Gmail redirection
        return `<a href="${gmailComposeUrl}" style="color: white; text-decoration: underline;" target="_blank">${email}</a>`;
    }
},

            { title: "Group", field: "grade_and_section", width: 80 },
            { title: "Phone Number", field: "phone_number", width: 100 },
            {
                title: "Actions", 
                field: "actions", 
                hozAlign: "center", // Align content horizontally to center
                formatter: function(cell, formatterParams, onRendered) {
                    return ''; // Placeholder for future actions (e.g., Mark Found)
                },
                width: 120
            }
        ],

        rowClick: function (e, row) {
            const rowData = row.getData(); // Get the row data
            console.log("Row clicked, data:", rowData); // Log clicked row data
        },
    });

    // Cell Click Event for Filtering
    document.getElementById('table-container').addEventListener('click', function(e) {
        const cell = e.target.closest('.tabulator-cell'); // Find the closest tabulator cell
        if (cell) {
            const value = cell.textContent.trim().toLowerCase(); // Get the cell value
            console.log("Cell clicked, value:", value); // Log the clicked value

            // Filter the table based on the clicked cell's value
            table.clearFilter(); // Clear previous filters
            table.setFilter(function(data) {
                // Check if any field contains the clicked value (partial match)
                return Object.values(data).some(val =>
                    String(val).toLowerCase().includes(value)
                );
            });
        }
    });

    // Search input event
    document.getElementById('search-input').addEventListener('input', function (e) {
        const value = e.target.value.toLowerCase();
        table.clearFilter(); // Clear previous filters
        table.setFilter(function (data) {
            return Object.values(data).some(val =>
                String(val).toLowerCase().includes(value)
            );
        });
    });

    // Reset Button Event
    document.getElementById('reset-btn').addEventListener('click', function () {
        table.clearFilter(); // Clear all filters and show all rows
    });

    // Reset on Click Outside Table
    document.addEventListener('click', function(e) {
        if (!document.getElementById('table-container').contains(e.target) &&
            !document.getElementById('search-input').contains(e.target)) {
            table.clearFilter(); // Reset table if clicked outside the table or search input
        }
    });
});

</script>

{% endblock %}
